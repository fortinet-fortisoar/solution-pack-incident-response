{
    "@type": "Workflow",
    "triggerLimit": null,
    "name": "Export as CSV",
    "aliasName": null,
    "tag": null,
    "description": "Export all records of the given module with specified filters in the CSV format.",
    "isActive": false,
    "debug": false,
    "singleRecordExecution": false,
    "remoteExecutableFlag": false,
    "parameters": [],
    "synchronous": false,
    "lastModifyDate": 1637679100,
    "collection": "\/api\/3\/workflow_collections\/20289298-cdd6-4052-8fa0-11e2603dca00",
    "versions": [],
    "triggerStep": "\/api\/3\/workflow_steps\/29d03437-e199-4d83-afd1-fb03dfb7b87d",
    "steps": [
        {
            "@type": "WorkflowStep",
            "name": "Send Email",
            "description": null,
            "arguments": {
                "config": "88c3d39c-2fa9-4731-b00d-29815008f17c",
                "params": {
                    "cc": "",
                    "to": "{{vars.toEmailAddress}}",
                    "bcc": "",
                    "from": "{{vars.fromEmailAddress}}",
                    "type": "Manual Input",
                    "content": "Incident Export at {{ arrow.utcnow() }}",
                    "subject": "Incident Export Attached",
                    "iri_list": "",
                    "body_type": "Plain Text",
                    "file_name": "{{ vars.resultsFileName }}.zip",
                    "file_path": "{{ vars.resultsFileName }}.zip"
                },
                "version": "2.3.0",
                "from_str": "soc@cybersponse.com",
                "connector": "smtp",
                "operation": "send_email_new",
                "operationTitle": "Send Email",
                "step_variables": []
            },
            "status": null,
            "top": "975",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/4c0019b2-055c-44d0-968c-678a0c2d762e",
            "uuid": "a3d1dab2-bc75-4410-8a5b-6c27b16e3206",
            "id": 4113
        },
        {
            "@type": "WorkflowStep",
            "name": "Start",
            "description": null,
            "arguments": {
                "route": "c1305aab-cfe7-4b6f-9227-f16ded912bf5",
                "title": "Export > All Records Data",
                "resources": [
                    "incidents"
                ],
                "inputVariables": [
                    {
                        "name": "emailID",
                        "type": "string",
                        "label": "Email ID",
                        "tooltip": "Please Enter Email ID for receiving report",
                        "dataType": "text",
                        "formType": "text",
                        "required": true,
                        "_expanded": true,
                        "defaultValue": "",
                        "useRecordFieldDefault": false
                    }
                ],
                "step_variables": {
                    "input": {
                        "params": {
                            "emailID": "{{vars.request.data[\"emailID\"]}}"
                        },
                        "records": "{{vars.input.records}}"
                    }
                },
                "_promptexpanded": true,
                "displayConditions": {
                    "incidents": {
                        "sort": [],
                        "limit": 30,
                        "logic": "AND",
                        "filters": []
                    }
                },
                "executeButtonText": "Execute",
                "noRecordExecution": true,
                "singleRecordExecution": false
            },
            "status": null,
            "top": "30",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/f414d039-bb0d-4e59-9c39-a8f1e880b18a",
            "uuid": "29d03437-e199-4d83-afd1-fb03dfb7b87d",
            "id": 4114
        },
        {
            "@type": "WorkflowStep",
            "name": "Set Pages",
            "description": null,
            "arguments": {
                "pageRange": "{% set _list=[] %}{% if vars.pages >= 1%}{% for n in range(1, vars.pages + 1) %}{% set _temp=_list.append(n) %}{% endfor %}{% endif %}{{ _list }}"
            },
            "status": null,
            "top": "570",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "b5fd78e6-4e0e-40c3-be23-9e1255a4ba3e",
            "id": 4115
        },
        {
            "@type": "WorkflowStep",
            "name": "Configuration",
            "description": null,
            "arguments": {
                "pageSize": "250",
                "moduleName": "incidents",
                "toEmailAddress": "{{vars.input.params.emailID}}",
                "incidentsFilter": "{ \n   \"filters\":[ \n      { \n         \"field\":\"name\",\n         \"operator\":\"like\",\n         \"value\":\"%Suspicious%\"\n      },\n      { \n         \"field\":\"createDate\",\n         \"operator\":\"gt\",\n         \"value\":\"2018-01-31T16:22:55.297317+05:30\"\n      }\n   ],\n   \"logic\":\"AND\",\n  \"__selectFields\":[\"name\",\"category\",\"dueby\",\"phase\",\"status\",\"severity\",\"incidentLead\",\"createDate\",\"dateOfIncident\",\"id\",\"createUser\",\"modifyUser\"]\n}",
                "resultsFileName": "incidentExport-{{ arrow.utcnow().timestamp }}",
                "fromEmailAddress": "no-reply@cybersponse.com",
                "datetimeFieldsToConvert": "[\"createDate\", \"dueby\", \"dateOfIncident\"]"
            },
            "status": null,
            "top": "165",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/04d0cf46-b6a8-42c4-8683-60a7eaa69e8f",
            "uuid": "30bce660-ba15-4224-8f4e-54e699b246db",
            "id": 4116
        },
        {
            "@type": "WorkflowStep",
            "name": "Write Headers To File",
            "description": null,
            "arguments": {
                "config": "0fd89191-0436-4ba1-8eca-88771f17e159",
                "params": {
                    "python_function": "import csv\n\nrecordsToSave = {{vars.steps.Find_Records_Paginated.data[\"hydra:member\"]}} \ncolumns = recordsToSave[0].keys()\ncolumnsToAdd = [item for item in columns if item in {{ vars.incidentsFilter.__selectFields}}]\nwith open('\/tmp\/{{vars.resultsFileName}}.csv','w') as out_file:\n    csv_w = csv.writer(out_file)\n    csv_w.writerow(columnsToAdd)"
                },
                "version": "1.2.1",
                "connector": "code-snippet",
                "operation": "python_inline",
                "operationTitle": "Execute Python Code",
                "step_variables": []
            },
            "status": null,
            "top": "435",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/1fdd14cc-d6b4-4335-a3af-ab49c8ed2fd8",
            "uuid": "6b33bcf4-af8e-4014-920f-87677855f34e",
            "id": 4117
        },
        {
            "@type": "WorkflowStep",
            "name": "Find Records Paginated",
            "description": null,
            "arguments": {
                "params": {
                    "iri": "\/api\/query\/{{vars.moduleName}}?$limit={{vars.pageSize}}",
                    "body": "{{ vars.incidentsFilter }}",
                    "method": "POST"
                },
                "version": "2.7.0",
                "connector": "cyops_utilities",
                "operation": "make_cyops_request",
                "operationTitle": "CyOPs: Make CyOPs API Call",
                "step_variables": {
                    "pages": "{{(vars.result.data['hydra:totalItems']\/vars.result.data['hydra:itemsPerPage']) | round(0, 'ceil') | int}}"
                }
            },
            "status": null,
            "top": "300",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "uuid": "aea9a8d0-cd2f-450d-ac86-f0716dff19fa",
            "id": 4118
        },
        {
            "@type": "WorkflowStep",
            "name": "Compress File",
            "description": null,
            "arguments": {
                "params": {
                    "filename": "{{vars.resultsFileName}}.csv",
                    "password": "",
                    "compress_level": 6,
                    "target_filename": "{{vars.resultsFileName}}.zip"
                },
                "version": "2.7.0",
                "connector": "cyops_utilities",
                "operation": "zip_and_protect_file",
                "operationTitle": "File: Zip",
                "step_variables": []
            },
            "status": null,
            "top": "840",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/0109f35d-090b-4a2b-bd8a-94cbc3508562",
            "uuid": "83f0c562-ea3f-4556-8b17-e20e43e0e48b",
            "id": 4119
        },
        {
            "@type": "WorkflowStep",
            "name": "Append Paginated Results",
            "description": null,
            "arguments": {
                "when": "{{vars.pages >= 1}}",
                "for_each": {
                    "item": "{{ vars.pageRange }}",
                    "condition": ""
                },
                "arguments": {
                    "queryURL": "\/api\/query\/{{vars.moduleName}}?$limit={{vars.pageSize}}&$page={{vars.item}}",
                    "queryBody": "{{vars.incidentsFilter}}",
                    "fileToUpdate": "\/tmp\/{{vars.resultsFileName}}.csv",
                    "datetimeFieldsToConvert": "{{vars.datetimeFieldsToConvert}}"
                },
                "apply_async": false,
                "step_variables": [],
                "workflowReference": "\/api\/3\/workflows\/040d22ad-4796-4154-8592-c89af670abb5"
            },
            "status": null,
            "top": "705",
            "left": "125",
            "stepType": "\/api\/3\/workflow_step_types\/74932bdc-b8b6-4d24-88c4-1a4dfbc524f3",
            "uuid": "e7618b94-83b3-45b1-b7bc-a9adb35247c8",
            "id": 4120
        }
    ],
    "routes": [
        {
            "@type": "WorkflowRoute",
            "name": "Compress File -> Send Email",
            "targetStep": "\/api\/3\/workflow_steps\/a3d1dab2-bc75-4410-8a5b-6c27b16e3206",
            "sourceStep": "\/api\/3\/workflow_steps\/83f0c562-ea3f-4556-8b17-e20e43e0e48b",
            "label": null,
            "isExecuted": false,
            "uuid": "7ff63668-ccc3-473e-9652-ad1dbd109656"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Start -> Set Incident Filter",
            "targetStep": "\/api\/3\/workflow_steps\/30bce660-ba15-4224-8f4e-54e699b246db",
            "sourceStep": "\/api\/3\/workflow_steps\/29d03437-e199-4d83-afd1-fb03dfb7b87d",
            "label": null,
            "isExecuted": false,
            "uuid": "9ef6f883-cdb4-48ff-a34f-fe4b7f036030"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Set Pages -> Append next page results",
            "targetStep": "\/api\/3\/workflow_steps\/e7618b94-83b3-45b1-b7bc-a9adb35247c8",
            "sourceStep": "\/api\/3\/workflow_steps\/b5fd78e6-4e0e-40c3-be23-9e1255a4ba3e",
            "label": null,
            "isExecuted": false,
            "uuid": "2a20d0ce-f017-4006-b616-828b5a6fb11f"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Append next page results -> Compress File",
            "targetStep": "\/api\/3\/workflow_steps\/83f0c562-ea3f-4556-8b17-e20e43e0e48b",
            "sourceStep": "\/api\/3\/workflow_steps\/e7618b94-83b3-45b1-b7bc-a9adb35247c8",
            "label": null,
            "isExecuted": false,
            "uuid": "549e17f0-9b1d-41d3-904c-743b1afefb9b"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Set Incident Filter -> Find Records Paginated",
            "targetStep": "\/api\/3\/workflow_steps\/aea9a8d0-cd2f-450d-ac86-f0716dff19fa",
            "sourceStep": "\/api\/3\/workflow_steps\/30bce660-ba15-4224-8f4e-54e699b246db",
            "label": null,
            "isExecuted": false,
            "uuid": "4b2cbfc3-b3ab-43a7-9d3f-4ea3a542b08a"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Write Results To File -> Set Pages",
            "targetStep": "\/api\/3\/workflow_steps\/b5fd78e6-4e0e-40c3-be23-9e1255a4ba3e",
            "sourceStep": "\/api\/3\/workflow_steps\/6b33bcf4-af8e-4014-920f-87677855f34e",
            "label": null,
            "isExecuted": false,
            "uuid": "3bbd868a-7cad-411d-aa65-052c7ac5761c"
        },
        {
            "@type": "WorkflowRoute",
            "name": "Find Records Paginated -> Write Results To File",
            "targetStep": "\/api\/3\/workflow_steps\/6b33bcf4-af8e-4014-920f-87677855f34e",
            "sourceStep": "\/api\/3\/workflow_steps\/aea9a8d0-cd2f-450d-ac86-f0716dff19fa",
            "label": null,
            "isExecuted": false,
            "uuid": "f685478d-5873-4743-9ab8-84e9e88f621c"
        }
    ],
    "priority": null,
    "uuid": "967f8066-8cec-4d90-a2fe-d387be29e5c8",
    "recordTags": [
        "ManualAction"
    ],
    "id": 1112,
    "createUser": "\/api\/3\/appliances\/57545210-2adc-472b-a24f-2df6ee8dfe63",
    "createDate": 1637679115,
    "modifyUser": "\/api\/3\/appliances\/57545210-2adc-472b-a24f-2df6ee8dfe63",
    "modifyDate": 1637679115,
    "owners": [],
    "isPrivate": false
}